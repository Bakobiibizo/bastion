#!/usr/bin/env bash
# agent — CLI wrapper for bastion-agent HTTP API
#
# Usage:
#   agent <command> [args...]
#
# Commands:
#   me                          — show identity + contact string
#   status                      — network status
#   peers                       — list connected peers
#   contacts                    — list contacts
#   add <harbor://...>          — add contact from string
#   msg <name|peer_id> <text>   — send message
#   messages <name|peer_id>     — read conversation
#   conversations               — list conversations
#   relay <multiaddr>           — connect to relay
#   connect <multiaddr>         — dial a peer directly
#   events                      — stream SSE events (Ctrl+C to stop)
#   boards                      — list joined enclaves
#   join <relay_addr>           — join an enclave
#   raw <METHOD> <path> [json]  — raw API call
#
# Environment:
#   BASTION_PORT  — agent port (default 8745)
#   BASTION_HOST  — agent host (default 127.0.0.1)

set -euo pipefail

PORT="${BASTION_PORT:-8745}"
HOST="${BASTION_HOST:-127.0.0.1}"
BASE="http://${HOST}:${PORT}"

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
DIM='\033[2m'
NC='\033[0m'

die()  { echo -e "${RED}error:${NC} $1" >&2; exit 1; }
info() { echo -e "${CYAN}$1${NC}"; }

# ── API helper ────────────────────────────────────────────
api() {
  local method="$1" path="$2"
  shift 2
  local resp
  resp=$(curl -sf -X "$method" "${BASE}${path}" -H 'Content-Type: application/json' "$@" 2>/dev/null) || {
    die "API call failed: $method $path (is the agent running on ${BASE}?)"
  }
  echo "$resp"
}

# ── Resolve a name or partial peer ID to a full peer ID ──
resolve_peer() {
  local query="$1"

  # Already a full peer ID
  if [[ "$query" =~ ^12D3KooW.{44}$ ]]; then
    echo "$query"
    return
  fi

  # Try contacts first — match by display name (case-insensitive)
  local contacts
  contacts=$(api GET /api/contacts 2>/dev/null) || true

  if [ -n "$contacts" ] && [ "$contacts" != "[]" ]; then
    local match
    match=$(echo "$contacts" | python3 -c "
import sys, json
contacts = json.load(sys.stdin)
query = '${query}'.lower()
for c in contacts:
    name = c.get('displayName', '').lower()
    pid = c.get('peerId', '')
    if query == name or query in name or pid.startswith(query) or pid.endswith(query):
        print(pid)
        break
" 2>/dev/null) || true

    if [ -n "$match" ]; then
      echo "$match"
      return
    fi
  fi

  # Try connected peers — match by partial peer ID
  local peers
  peers=$(api GET /api/network/peers 2>/dev/null) || true

  if [ -n "$peers" ] && [ "$peers" != "[]" ]; then
    local match
    match=$(echo "$peers" | python3 -c "
import sys, json
peers = json.load(sys.stdin)
query = '${query}'.lower()
for p in peers:
    pid = p.get('peerId', '')
    if pid.lower().startswith(query.lower()) or pid.lower().endswith(query.lower()):
        print(pid)
        break
" 2>/dev/null) || true

    if [ -n "$match" ]; then
      echo "$match"
      return
    fi
  fi

  die "Could not resolve '${query}' to a peer ID. Use full ID, display name, or partial ID."
}

# ── Pretty-print JSON ────────────────────────────────────
pp() {
  python3 -m json.tool 2>/dev/null || cat
}

# ── Commands ──────────────────────────────────────────────

cmd_me() {
  local id
  id=$(api GET /api/identity)
  local peer_id display bio
  peer_id=$(echo "$id" | python3 -c "import sys,json; print(json.load(sys.stdin).get('peerId','?'))" 2>/dev/null)
  display=$(echo "$id" | python3 -c "import sys,json; print(json.load(sys.stdin).get('displayName','?'))" 2>/dev/null)
  bio=$(echo "$id" | python3 -c "import sys,json; print(json.load(sys.stdin).get('bio',''))" 2>/dev/null)

  echo -e "${GREEN}${display}${NC}"
  echo -e "${DIM}${peer_id}${NC}"
  [ -n "$bio" ] && echo -e "${DIM}${bio}${NC}"

  local contact_str
  contact_str=$(curl -sf "${BASE}/api/network/contact-string" 2>/dev/null || echo "")
  if echo "$contact_str" | grep -q "harbor://"; then
    echo ""
    echo -e "${YELLOW}Contact string:${NC}"
    echo "$contact_str" | tr -d '"'
  else
    echo -e "\n${DIM}No contact string (connect to a relay first)${NC}"
  fi
}

cmd_status() {
  local status
  status=$(api GET /api/network/status)
  local running peers relay_addrs
  running=$(echo "$status" | python3 -c "import sys,json; print(json.load(sys.stdin).get('running', False))" 2>/dev/null)
  peers=$(echo "$status" | python3 -c "import sys,json; print(json.load(sys.stdin).get('stats',{}).get('connectedPeers',0))" 2>/dev/null)
  relay_addrs=$(echo "$status" | python3 -c "
import sys, json
s = json.load(sys.stdin)
addrs = s.get('relayAddresses', [])
for a in addrs:
    print(a)
" 2>/dev/null)

  echo -e "Network:  $([ "$running" = "True" ] && echo -e "${GREEN}running${NC}" || echo -e "${RED}stopped${NC}")"
  echo -e "Peers:    ${peers}"

  if [ -n "$relay_addrs" ]; then
    echo -e "Relay:"
    echo "$relay_addrs" | while read -r addr; do
      echo -e "  ${DIM}${addr}${NC}"
    done
  fi
}

cmd_peers() {
  local peers
  peers=$(api GET /api/network/peers)

  if [ "$peers" = "[]" ]; then
    echo -e "${DIM}No connected peers${NC}"
    return
  fi

  echo "$peers" | python3 -c "
import sys, json
peers = json.load(sys.stdin)
for p in peers:
    pid = p.get('peerId', '?')
    proto = p.get('protocolVersion', '?')
    agent = p.get('agentVersion', '')
    short = pid[:16] + '...' + pid[-6:]
    info = f' ({proto})'
    if agent:
        info += f' {agent}'
    print(f'  {short}{info}')
print(f'\n  {len(peers)} peer(s) connected')
" 2>/dev/null
}

cmd_contacts() {
  local contacts
  contacts=$(api GET /api/contacts)

  if [ "$contacts" = "[]" ]; then
    echo -e "${DIM}No contacts${NC}"
    return
  fi

  echo "$contacts" | python3 -c "
import sys, json
contacts = json.load(sys.stdin)
for c in contacts:
    name = c.get('displayName', '?')
    pid = c.get('peerId', '?')
    short = pid[:16] + '...' + pid[-6:]
    print(f'  {name:20s} {short}')
print(f'\n  {len(contacts)} contact(s)')
" 2>/dev/null
}

cmd_add() {
  local contact_str="${1:-}"
  [ -z "$contact_str" ] && die "Usage: agent add <harbor://...>"

  local result
  result=$(api POST /api/contacts/from-string -d "{\"contactString\":\"${contact_str}\"}")

  if echo "$result" | grep -q "12D3KooW"; then
    local peer_id
    peer_id=$(echo "$result" | tr -d '"')
    echo -e "${GREEN}Added contact:${NC} ${peer_id}"
  else
    echo -e "${RED}Failed:${NC} $result"
  fi
}

cmd_msg() {
  local target="${1:-}"
  shift || true
  local content="$*"

  [ -z "$target" ] && die "Usage: agent msg <name|peer_id> <message>"
  [ -z "$content" ] && die "Usage: agent msg <name|peer_id> <message>"

  local peer_id
  peer_id=$(resolve_peer "$target")

  local result
  result=$(api POST /api/messages/send -d "{\"peerId\":\"${peer_id}\",\"content\":\"${content}\"}")

  echo -e "${GREEN}Sent to${NC} ${peer_id:0:16}...${peer_id: -6}: ${content}"
}

cmd_messages() {
  local target="${1:-}"
  [ -z "$target" ] && die "Usage: agent messages <name|peer_id>"

  local peer_id
  peer_id=$(resolve_peer "$target")

  local msgs
  msgs=$(api GET "/api/messages/${peer_id}")

  if [ "$msgs" = "[]" ]; then
    echo -e "${DIM}No messages with ${peer_id:0:16}...${NC}"
    return
  fi

  echo "$msgs" | python3 -c "
import sys, json
msgs = json.load(sys.stdin)
for m in msgs:
    sender = m.get('senderPeerId', '?')[:16]
    content = m.get('content', '')
    ts = m.get('timestamp', '')[:19].replace('T', ' ')
    direction = '→' if m.get('isOutgoing', False) else '←'
    print(f'  {ts} {direction} {content}')
print(f'\n  {len(msgs)} message(s)')
" 2>/dev/null
}

cmd_conversations() {
  local convos
  convos=$(api GET /api/conversations)

  if [ "$convos" = "[]" ]; then
    echo -e "${DIM}No conversations${NC}"
    return
  fi

  echo "$convos" | python3 -c "
import sys, json
convos = json.load(sys.stdin)
for c in convos:
    pid = c.get('peerId', '?')
    short = pid[:16] + '...' + pid[-6:]
    unread = c.get('unreadCount', 0)
    last = c.get('lastMessage', '')[:50]
    marker = f' ({unread} unread)' if unread > 0 else ''
    print(f'  {short}{marker}')
    if last:
        print(f'    {last}')
print(f'\n  {len(convos)} conversation(s)')
" 2>/dev/null
}

cmd_relay() {
  local multiaddr="${1:-}"
  [ -z "$multiaddr" ] && die "Usage: agent relay <multiaddr>"

  api POST /api/network/relay -d "{\"multiaddr\":\"${multiaddr}\"}" >/dev/null
  echo -e "${GREEN}Connecting to relay...${NC}"
  sleep 2
  cmd_status
}

cmd_connect() {
  local multiaddr="${1:-}"
  [ -z "$multiaddr" ] && die "Usage: agent connect <multiaddr>"

  api POST /api/network/connect -d "{\"multiaddr\":\"${multiaddr}\"}" >/dev/null
  echo -e "${GREEN}Dialing...${NC}"
}

cmd_events() {
  info "Streaming events (Ctrl+C to stop)..."
  curl -sN "${BASE}/api/events" 2>/dev/null
}

cmd_boards() {
  local communities
  communities=$(api GET /api/communities)
  echo "$communities" | pp
}

cmd_join() {
  local relay_addr="${1:-}"
  [ -z "$relay_addr" ] && die "Usage: agent join <relay_address>"

  local result
  result=$(api POST /api/communities/join -d "{\"relayAddress\":\"${relay_addr}\"}")
  echo "$result" | pp
}

cmd_raw() {
  local method="${1:-GET}" path="${2:-/api/identity}"
  shift 2 || true
  local body="$*"

  if [ -n "$body" ]; then
    api "$method" "$path" -d "$body" | pp
  else
    api "$method" "$path" | pp
  fi
}

cmd_help() {
  cat <<'EOF'
agent — CLI for bastion-agent API

Commands:
  me                          Show identity + contact string
  status                      Network status
  peers                       List connected peers
  contacts                    List contacts
  add <harbor://...>          Add contact from string
  msg <name|id> <text>        Send a message
  messages <name|id>          Read conversation
  conversations               List all conversations
  relay <multiaddr>           Connect to relay
  connect <multiaddr>         Dial peer directly
  events                      Stream SSE events
  boards                      List joined enclaves
  join <relay_addr>           Join an enclave
  raw <METHOD> <path> [json]  Raw API call
  help                        This help

Name resolution:
  Most commands accept a display name, partial peer ID, or full peer ID.
  Names are matched against contacts first, then connected peers.

Environment:
  BASTION_PORT  Agent port (default 8745)
  BASTION_HOST  Agent host (default 127.0.0.1)
EOF
}

# ── Dispatch ──────────────────────────────────────────────
CMD="${1:-help}"
shift || true

case "$CMD" in
  me)             cmd_me "$@" ;;
  status|stat|s)  cmd_status "$@" ;;
  peers|p)        cmd_peers "$@" ;;
  contacts|c)     cmd_contacts "$@" ;;
  add|a)          cmd_add "$@" ;;
  msg|m|send)     cmd_msg "$@" ;;
  messages|read)  cmd_messages "$@" ;;
  conversations|convos) cmd_conversations "$@" ;;
  relay|r)        cmd_relay "$@" ;;
  connect|dial)   cmd_connect "$@" ;;
  events|e)       cmd_events "$@" ;;
  boards|b)       cmd_boards "$@" ;;
  join|j)         cmd_join "$@" ;;
  raw)            cmd_raw "$@" ;;
  help|h|--help|-h) cmd_help ;;
  *)              die "Unknown command: $CMD (try 'agent help')" ;;
esac
