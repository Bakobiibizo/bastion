#!/usr/bin/env bash
# bako-agent — Start your own bastion-agent and get a CLI
#
# Usage:
#   ./bako-agent setup                  — first run: build + create identity
#   ./bako-agent start                  — start agent daemon
#   ./bako-agent stop                   — stop agent daemon
#   ./bako-agent <any agent command>    — forwarded to agent CLI
#
# Examples:
#   ./bako-agent setup
#   ./bako-agent start
#   ./bako-agent relay /ip4/35.173.176.243/tcp/4001/p2p/12D3KooWHi81G15poZuH4BL5WnifQ3b2S2uSkvsa1wAhBZNA8PW9
#   ./bako-agent me
#   ./bako-agent add "harbor://eyJ..."
#   ./bako-agent msg erasmus "hello from the other side"
#   ./bako-agent stop

set -euo pipefail

# ── Config (edit these) ──────────────────────────────────
PORT="${BASTION_PORT:-8746}"
DATA_DIR="${BASTION_DATA_DIR:-$HOME/.bastion-bako}"
PASSPHRASE="${BASTION_PASSPHRASE:-bako-test-2026}"
DISPLAY_NAME="${BASTION_NAME:-bako}"
BIO="${BASTION_BIO:-Bakobiibizo}"
AGENT_BIN="${BASTION_BIN:-bastion-agent}"
# ─────────────────────────────────────────────────────────

BASE="http://127.0.0.1:${PORT}"
PIDFILE="${DATA_DIR}/agent.pid"
LOGFILE="${DATA_DIR}/logs/agent.log"

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
DIM='\033[2m'
NC='\033[0m'

die()  { echo -e "${RED}error:${NC} $1" >&2; exit 1; }
info() { echo -e "${CYAN}→${NC} $1"; }
pass() { echo -e "${GREEN}✓${NC} $1"; }

api() {
  local method="$1" path="$2"
  shift 2
  curl -sf -X "$method" "${BASE}${path}" -H 'Content-Type: application/json' "$@" 2>/dev/null
}

wait_for_api() {
  for i in $(seq 1 30); do
    if curl -sf "${BASE}/api/identity/status" >/dev/null 2>&1; then
      return 0
    fi
    sleep 0.5
  done
  return 1
}

is_running() {
  if [ -f "$PIDFILE" ]; then
    local pid
    pid=$(cat "$PIDFILE")
    if kill -0 "$pid" 2>/dev/null; then
      return 0
    fi
  fi
  return 1
}

# ── Commands ─────────────────────────────────────────────

cmd_setup() {
  echo -e "${YELLOW}Setting up bastion-agent for ${DISPLAY_NAME}${NC}"
  echo ""

  # Check binary
  if ! command -v "$AGENT_BIN" >/dev/null 2>&1; then
    if [ -f "./harbor-agent/target/release/bastion-agent" ]; then
      AGENT_BIN="./harbor-agent/target/release/bastion-agent"
    elif [ -f "./target/release/bastion-agent" ]; then
      AGENT_BIN="./target/release/bastion-agent"
    else
      echo -e "${YELLOW}Building bastion-agent...${NC}"
      if [ -f "harbor-agent/Cargo.toml" ]; then
        cargo build --release --manifest-path harbor-agent/Cargo.toml
        AGENT_BIN="./harbor-agent/target/release/bastion-agent"
      elif [ -f "Cargo.toml" ]; then
        cargo build --release
        AGENT_BIN="./target/release/bastion-agent"
      else
        die "Can't find bastion-agent binary or Cargo.toml. Set BASTION_BIN=<path>"
      fi
    fi
  fi
  pass "Binary: $AGENT_BIN"

  # Create dirs
  mkdir -p "${DATA_DIR}/logs"
  pass "Data dir: $DATA_DIR"

  # Start temporarily to create identity
  info "Starting agent to create identity..."
  "$AGENT_BIN" --data-dir "$DATA_DIR" --port "$PORT" --passphrase "$PASSPHRASE" --auto-network &
  local tmp_pid=$!

  if ! wait_for_api; then
    kill "$tmp_pid" 2>/dev/null || true
    die "Agent failed to start"
  fi

  # Check if identity exists
  local status
  status=$(api GET /api/identity/status)
  local has_id
  has_id=$(echo "$status" | python3 -c "import sys,json; print(json.load(sys.stdin)['hasIdentity'])" 2>/dev/null)

  if [ "$has_id" = "True" ]; then
    pass "Identity already exists"
    local id_info
    id_info=$(api GET /api/identity)
    local peer_id
    peer_id=$(echo "$id_info" | python3 -c "import sys,json; print(json.load(sys.stdin)['peerId'])" 2>/dev/null)
    pass "Peer ID: $peer_id"
  else
    info "Creating identity: ${DISPLAY_NAME}"
    local result
    result=$(api POST /api/identity -d "{\"displayName\":\"${DISPLAY_NAME}\",\"passphrase\":\"${PASSPHRASE}\",\"bio\":\"${BIO}\"}")
    local peer_id
    peer_id=$(echo "$result" | python3 -c "import sys,json; print(json.load(sys.stdin)['peerId'])" 2>/dev/null)
    if [ -n "$peer_id" ]; then
      pass "Created identity: ${DISPLAY_NAME} (${peer_id})"
    else
      kill "$tmp_pid" 2>/dev/null || true
      die "Failed to create identity: $result"
    fi
  fi

  # Stop the temp instance
  kill "$tmp_pid" 2>/dev/null || true
  wait "$tmp_pid" 2>/dev/null || true

  echo ""
  pass "Setup complete. Run: $0 start"
}

cmd_start() {
  if is_running; then
    local pid
    pid=$(cat "$PIDFILE")
    pass "Already running (PID ${pid})"
    return
  fi

  mkdir -p "${DATA_DIR}/logs"

  # Find binary
  if ! command -v "$AGENT_BIN" >/dev/null 2>&1; then
    for candidate in \
      "./harbor-agent/target/release/bastion-agent" \
      "./target/release/bastion-agent" \
      "$HOME/.cargo/bin/bastion-agent"; do
      if [ -x "$candidate" ]; then
        AGENT_BIN="$candidate"
        break
      fi
    done
  fi

  command -v "$AGENT_BIN" >/dev/null 2>&1 || [ -x "$AGENT_BIN" ] || \
    die "Cannot find bastion-agent binary. Set BASTION_BIN=<path>"

  nohup "$AGENT_BIN" \
    --data-dir "$DATA_DIR" \
    --port "$PORT" \
    --passphrase "$PASSPHRASE" \
    --auto-network \
    > "$LOGFILE" 2>&1 &

  echo $! > "$PIDFILE"
  disown 2>/dev/null || true

  if wait_for_api; then
    local pid
    pid=$(cat "$PIDFILE")
    pass "Agent started (PID ${pid}) on port ${PORT}"

    # Show identity
    local id_info
    id_info=$(api GET /api/identity 2>/dev/null || echo "{}")
    local peer_id display
    peer_id=$(echo "$id_info" | python3 -c "import sys,json; print(json.load(sys.stdin).get('peerId','?'))" 2>/dev/null)
    display=$(echo "$id_info" | python3 -c "import sys,json; print(json.load(sys.stdin).get('displayName','?'))" 2>/dev/null)
    echo -e "  ${GREEN}${display}${NC} ${DIM}${peer_id}${NC}"
    echo -e "  ${DIM}Logs: ${LOGFILE}${NC}"
  else
    die "Agent failed to start. Check ${LOGFILE}"
  fi
}

cmd_stop() {
  if ! is_running; then
    info "Not running"
    return
  fi

  local pid
  pid=$(cat "$PIDFILE")
  kill "$pid" 2>/dev/null || true
  wait "$pid" 2>/dev/null || true
  rm -f "$PIDFILE"
  pass "Stopped (was PID ${pid})"
}

cmd_logs() {
  if [ -f "$LOGFILE" ]; then
    tail -f "$LOGFILE"
  else
    die "No log file at $LOGFILE"
  fi
}

# ── Agent CLI (forwarded commands) ───────────────────────

pp() { python3 -m json.tool 2>/dev/null || cat; }

resolve_peer() {
  local query="$1"
  if [[ "$query" =~ ^12D3KooW.{44}$ ]]; then
    echo "$query"; return
  fi
  local contacts
  contacts=$(api GET /api/contacts 2>/dev/null) || true
  if [ -n "$contacts" ] && [ "$contacts" != "[]" ]; then
    local match
    match=$(echo "$contacts" | python3 -c "
import sys, json
contacts = json.load(sys.stdin)
query = '${query}'.lower()
for c in contacts:
    name = c.get('displayName', '').lower()
    pid = c.get('peerId', '')
    if query == name or query in name or pid.startswith(query) or pid.endswith(query):
        print(pid); break
" 2>/dev/null) || true
    if [ -n "$match" ]; then echo "$match"; return; fi
  fi
  local peers
  peers=$(api GET /api/network/peers 2>/dev/null) || true
  if [ -n "$peers" ] && [ "$peers" != "[]" ]; then
    local match
    match=$(echo "$peers" | python3 -c "
import sys, json
peers = json.load(sys.stdin)
query = '${query}'.lower()
for p in peers:
    pid = p.get('peerId', '')
    if pid.lower().startswith(query.lower()) or pid.lower().endswith(query.lower()):
        print(pid); break
" 2>/dev/null) || true
    if [ -n "$match" ]; then echo "$match"; return; fi
  fi
  die "Could not resolve '${query}' to a peer ID"
}

cmd_me() {
  local id
  id=$(api GET /api/identity) || die "API not reachable (run: $0 start)"
  local peer_id display bio
  peer_id=$(echo "$id" | python3 -c "import sys,json; print(json.load(sys.stdin).get('peerId','?'))" 2>/dev/null)
  display=$(echo "$id" | python3 -c "import sys,json; print(json.load(sys.stdin).get('displayName','?'))" 2>/dev/null)
  bio=$(echo "$id" | python3 -c "import sys,json; print(json.load(sys.stdin).get('bio',''))" 2>/dev/null)
  echo -e "${GREEN}${display}${NC}"
  echo -e "${DIM}${peer_id}${NC}"
  [ -n "$bio" ] && echo -e "${DIM}${bio}${NC}"
  local contact_str
  contact_str=$(curl -sf "${BASE}/api/network/contact-string" 2>/dev/null || echo "")
  if echo "$contact_str" | grep -q "harbor://"; then
    echo ""
    echo -e "${YELLOW}Contact string:${NC}"
    echo "$contact_str" | tr -d '"'
  else
    echo -e "\n${DIM}No contact string (connect to a relay first)${NC}"
  fi
}

cmd_agent_status() {
  local status
  status=$(api GET /api/network/status) || die "API not reachable (run: $0 start)"
  local running peers
  running=$(echo "$status" | python3 -c "import sys,json; print(json.load(sys.stdin).get('running', False))" 2>/dev/null)
  peers=$(echo "$status" | python3 -c "import sys,json; print(json.load(sys.stdin).get('stats',{}).get('connectedPeers',0))" 2>/dev/null)
  local relay_addrs
  relay_addrs=$(echo "$status" | python3 -c "
import sys, json
for a in json.load(sys.stdin).get('relayAddresses', []): print(a)
" 2>/dev/null)
  echo -e "Network:  $([ "$running" = "True" ] && echo -e "${GREEN}running${NC}" || echo -e "${RED}stopped${NC}")"
  echo -e "Peers:    ${peers}"
  if [ -n "$relay_addrs" ]; then
    echo -e "Relay:"
    echo "$relay_addrs" | while read -r addr; do echo -e "  ${DIM}${addr}${NC}"; done
  fi
}

cmd_peers() {
  local peers
  peers=$(api GET /api/network/peers) || die "API not reachable"
  if [ "$peers" = "[]" ]; then echo -e "${DIM}No connected peers${NC}"; return; fi
  echo "$peers" | python3 -c "
import sys, json
peers = json.load(sys.stdin)
for p in peers:
    pid = p.get('peerId', '?')
    short = pid[:16] + '...' + pid[-6:]
    proto = p.get('protocolVersion', '?')
    print(f'  {short} ({proto})')
print(f'\n  {len(peers)} peer(s)')
" 2>/dev/null
}

cmd_contacts() {
  local contacts
  contacts=$(api GET /api/contacts) || die "API not reachable"
  if [ "$contacts" = "[]" ]; then echo -e "${DIM}No contacts${NC}"; return; fi
  echo "$contacts" | python3 -c "
import sys, json
for c in json.load(sys.stdin):
    name = c.get('displayName', '?')
    pid = c.get('peerId', '?')
    print(f'  {name:20s} {pid[:16]}...{pid[-6:]}')
" 2>/dev/null
}

cmd_add() {
  local cs="${1:-}"
  [ -z "$cs" ] && die "Usage: $0 add <harbor://...>"
  local result
  result=$(api POST /api/contacts/from-string -d "{\"contactString\":\"${cs}\"}") || die "API call failed"
  if echo "$result" | grep -q "12D3KooW"; then
    pass "Added: $(echo "$result" | tr -d '"')"
  else
    echo -e "${RED}Failed:${NC} $result"
  fi
}

cmd_msg() {
  local target="${1:-}"; shift || true
  local content="$*"
  [ -z "$target" ] && die "Usage: $0 msg <name|id> <message>"
  [ -z "$content" ] && die "Usage: $0 msg <name|id> <message>"
  local peer_id
  peer_id=$(resolve_peer "$target")
  api POST /api/messages/send -d "{\"peerId\":\"${peer_id}\",\"content\":\"${content}\"}" >/dev/null
  pass "Sent to ${peer_id:0:16}...${peer_id: -6}"
}

cmd_messages() {
  local target="${1:-}"
  [ -z "$target" ] && die "Usage: $0 messages <name|id>"
  local peer_id
  peer_id=$(resolve_peer "$target")
  local msgs
  msgs=$(api GET "/api/messages/${peer_id}") || die "API call failed"
  if [ "$msgs" = "[]" ]; then echo -e "${DIM}No messages${NC}"; return; fi
  echo "$msgs" | python3 -c "
import sys, json
for m in json.load(sys.stdin):
    ts = m.get('timestamp', '')[:19].replace('T', ' ')
    d = '→' if m.get('isOutgoing', False) else '←'
    print(f'  {ts} {d} {m.get(\"content\", \"\")}')
" 2>/dev/null
}

cmd_conversations() {
  local c
  c=$(api GET /api/conversations) || die "API not reachable"
  if [ "$c" = "[]" ]; then echo -e "${DIM}No conversations${NC}"; return; fi
  echo "$c" | python3 -c "
import sys, json
for c in json.load(sys.stdin):
    pid = c.get('peerId', '?')
    u = c.get('unreadCount', 0)
    tag = f' ({u} unread)' if u > 0 else ''
    print(f'  {pid[:16]}...{pid[-6:]}{tag}')
" 2>/dev/null
}

cmd_relay() {
  local addr="${1:-}"
  [ -z "$addr" ] && die "Usage: $0 relay <multiaddr>"
  api POST /api/network/relay -d "{\"multiaddr\":\"${addr}\"}" >/dev/null
  info "Connecting to relay..."
  sleep 3
  cmd_agent_status
}

cmd_connect() {
  local addr="${1:-}"
  [ -z "$addr" ] && die "Usage: $0 connect <multiaddr>"
  api POST /api/network/connect -d "{\"multiaddr\":\"${addr}\"}" >/dev/null
  pass "Dialing..."
}

cmd_events() { info "Streaming events (Ctrl+C to stop)..."; curl -sN "${BASE}/api/events"; }

cmd_raw() {
  local method="${1:-GET}" path="${2:-/api/identity}"; shift 2 || true
  local body="$*"
  if [ -n "$body" ]; then api "$method" "$path" -d "$body" | pp
  else api "$method" "$path" | pp; fi
}

cmd_help() {
  cat <<EOF
bako-agent — your bastion-agent instance

Daemon:
  setup                         First run: create identity
  start                         Start agent daemon
  stop                          Stop agent daemon
  logs                          Tail agent logs

Agent:
  me                            Your identity + contact string
  status                        Network status
  peers                         Connected peers
  contacts                      Your contacts
  add <harbor://...>            Add contact
  msg <name|id> <message>       Send message
  messages <name|id>            Read conversation
  conversations                 List conversations
  relay <multiaddr>             Connect to relay
  connect <multiaddr>           Dial peer
  events                        Stream SSE events
  raw <METHOD> <path> [json]    Raw API call
  help                          This help

Config (env vars):
  BASTION_PORT       Port (default 8746)
  BASTION_DATA_DIR   Data dir (default ~/.bastion-bako)
  BASTION_PASSPHRASE Passphrase (default bako-test-2026)
  BASTION_NAME       Display name (default bako)
  BASTION_BIN        Binary path (default: auto-detect)
EOF
}

# ── Dispatch ─────────────────────────────────────────────
CMD="${1:-help}"
shift || true

case "$CMD" in
  setup)                cmd_setup "$@" ;;
  start)                cmd_start "$@" ;;
  stop)                 cmd_stop "$@" ;;
  logs)                 cmd_logs "$@" ;;
  me)                   cmd_me "$@" ;;
  status|stat|s)        cmd_agent_status "$@" ;;
  peers|p)              cmd_peers "$@" ;;
  contacts|c)           cmd_contacts "$@" ;;
  add|a)                cmd_add "$@" ;;
  msg|m|send)           cmd_msg "$@" ;;
  messages|read)        cmd_messages "$@" ;;
  conversations|convos) cmd_conversations "$@" ;;
  relay|r)              cmd_relay "$@" ;;
  connect|dial)         cmd_connect "$@" ;;
  events|e)             cmd_events "$@" ;;
  raw)                  cmd_raw "$@" ;;
  help|h|--help|-h)     cmd_help ;;
  *)                    die "Unknown: $CMD (try: $0 help)" ;;
esac
